<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity-3"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/layout}"
>
  <section class="p-profile-app_learning_new" th:fragment="content">
    <!--カテゴリー名-->
    <input
      class="title"
      type="text"
      th:value="|${japaneseCategoriesMap.getOrDefault(currentCategoryName, '未分類')}に項目を追加|"
    />

    <!--入力フォーム-->
    <form
      th:action="@{/learning/save}"
      th:object="${learningRecord}"
      method="post"
    >
      <!--input hidden-->
      <input
        type="hidden"
        th:field="*{categoryName}"
        th:value="${currentCategoryName}"
      />
      <input
        type="hidden"
        th:field="*{recordedDate}"
        th:value="${#temporals.format(currentRecordedDate, 'yyyy-MM-dd')}"
      />

      <!-- 項目名 -->
      <table class="c-form mx-auto text-start">
        <tr>
          <th>項目名</th>
          <td
            th:classappend="${#fields.hasErrors('itemName')} ? 'hasErrors_validaton--form'"
          >
            <input
              class="input_form"
              type="text"
              th:field="*{itemName}"
              placeholder="PHP"
            />
          </td>
          <td
            th:if="${#fields.hasErrors('itemName')}"
            th:classappend="${#fields.hasErrors('itemName')} ? 'hasErrors_validaton--text'"
            th:errors="*{itemName}"
          >
            <span th:errors="*{itemName}"></span>
          </td>
        </tr>
        <!-- 学習時間 -->
        <tr>
          <th>学習時間</th>
          <td
            th:classappend="${#fields.hasErrors('learningTime')} ? 'hasErrors_validaton--form'"
          >
            <input
              type="number"
              class="input_form"
              th:field="*{learningTime}"
              placeholder="30"
            />
            <p
              th:unless="${#fields.hasErrors('learningTime')}"
              class="normal-status-text"
            >
              分単位で入力してください
            </p>
          </td>
          <td
            th:if="${#fields.hasErrors('learningTime')}"
            th:classappend="${#fields.hasErrors('learningTime')} ? 'hasErrors_validaton--text'"
          >
            <span th:errors="*{learningTime}"></span>
          </td>
        </tr>
      </table>
      <!-- 送信ボタン -->
      <button type="submit" class="c-btn--lg c-btn--lg--learnig_new">
        追加する
      </button>
    </form>
    <!-- Bootstrap モーダルの構造 -->
    <div
      class="modal fade custom-modal-bg"
      id="successModal"
      tabindex="-1"
      aria-labelledby="successModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content custom-modal-content">
          <p id="modal-message" class="modal-message-custom">
            <!--メッセージ-->
          </p>
          <button
            type="button"
            class="c-btn--lg--modal"
            id="redirectToListViewButton"
            th:attr="data-redirect-month=${currentMonthKey}"
            data-bs-dismiss="modal"
          >
            編集ページへ戻る
          </button>
        </div>
      </div>
    </div>
    <!--モーダル ここまで-->
  </section>
  <!--URLparameterの取得-->
  <script layout:fragment="script">
    var modelMonthKey = "null";
    var isOverwritten = false;

    window.selectedMonthKey = null;
    window.isMonthKeyOverwritten = false;

    if (modelMonthKey !== "null" && modelMonthKey.length === 7) {
      window.selectedMonthKey = modelMonthKey;
      window.isMonthKeyOverwritten = true;
    }
  </script>
  <!--日付の取得-->
  <script layout:fragment="script">
    function updateHiddenMonth(ym) {
      document.getElementById("hiddenMonth").value = ym + "-01";
    }
  </script>
  <!--Modal-->
  <script layout:fragment="script">
    // Bootstrap Modal インスタンスを保持するための変数
    let successModalInstance;
    let modalMessage;
    let globalFlashMessageData;

    const LIST_PAGE_URL = "/learning/list";

    function openSuccessModal(message, monthkey = null) {
      const modalElement = document.getElementById("successModal");

      // モーダルインスタンスの初期化
      if (!successModalInstance && modalElement) {
        successModalInstance = new bootstrap.Modal(modalElement, {
          backdrop: "static",
          keyboard: false,
        });
      }

      // モーダルを表示
      if (!modalMessage) {
        modalMessage = document.getElementById("modal-message");
      }

      // メッセージをモーダルボディに表示
      if (modalMessage) {
        const htmlMessage = message.replace(/\n/g, "<br>");
        modalMessage.innerHTML = htmlMessage;
      }

      // モーダルを表示
      if (successModalInstance) {
        successModalInstance.show();
      }
    }

    // モーダルを閉じる
    function closeSuccessModal() {
      if (successModalInstance) {
        successModalInstance.hide();
      }
    }

    // ページロード時の初期化処理
    document.addEventListener("DOMContentLoaded", function () {
      globalFlashMessageData = document.getElementById(
        "global-flash-message-data"
      );
      const redirectButton = document.getElementById(
        "redirectToListViewButton"
      );

      if (globalFlashMessageData && globalFlashMessageData.textContent.trim()) {
        const message = globalFlashMessageData.textContent.trim();

        if (message.length > 0 && message.indexOf("null") === -1) {
          openSuccessModal(message);

          globalFlashMessageData.textContent = "";
        }
      }

      if (redirectButton) {
        redirectButton.addEventListener("click", function (event) {
          let monthKeyToUse = redirectButton.getAttribute(
            "data-redirect-month"
          );
          let redirectUrl = LIST_PAGE_URL;

          if (
            window.isMonthKeyOverwritten === true &&
            monthKeyToUse &&
            monthKeyToUse.length === 7
          ) {
            if (
              !monthKeyToUse ||
              monthKeyToUse === "null" ||
              monthKeyToUse.length !== 7
            ) {
              const today = new Date();
              const year = today.getFullYear();
              const month = String(today.getMonth() + 1).padStart(2, "0");
              monthKeyToUse = `${year}-${month}`;
            }
          }

          // パラメータを付加
          redirectUrl += "?month=" + monthKeyToUse;

          window.location.replace(redirectUrl);
        });
      }
    });
  </script>
</html>
