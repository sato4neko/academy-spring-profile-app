<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity-3"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/layout}"
>
  <section class="p-profile-app_top" th:fragment="content">
    <div class="introduction_outer">
      <div class="introduction_inner--l">
        <img
          class="profile_image"
          alt="自己紹介画像"
          th:if="${isLoggedIn}"
          th:src="@{${userImage}}"
        />
        <p class="username" th:if="${isLoggedIn}">
          <span th:text="${username}"></span>さん
        </p>
      </div>
      <div class="introduction_inner--r">
        <h1 class="title" th:text="${self_introduction}"></h1>
        <p class="profile_detail" th:text="${profileDetail}"></p>
        <a th:href="@{/user/edit}" class="link__btn--edit c-btn--lg--top"
          >自己紹介を編集する</a
        >
      </div>
    </div>
    <div class="chart_outer">
      <div class="chart_inner">
        <h1 class="title" th:text="${learning_chart}"></h1>
        <a th:href="@{/learning/list}" class="link__btn--edit c-btn--md--chart"
          >編集する</a
        >
      </div>
      <div class="chart_container">
        <canvas id="myChart"></canvas>
      </div>
    </div>
  </section>
  <script layout:fragment="script" th:inline="javascript">
    /*<![CDATA[*/
    (function () {
      const initLearningChart = () => {
        const canvas = document.getElementById("myChart");
        if (!canvas) return;

        // Thymeleafからのデータ取得
        const rawLabels = /*[[${chartLabels}]]*/ [];
        const rawBackend = /*[[${backendData}]]*/ [];
        const rawFrontend = /*[[${frontendData}]]*/ [];
        const rawInfra = /*[[${infraData}]]*/ [];

        // データのフィルタリング
        const validMonths = [];
        for (let i = 0; i < rawLabels.length; i++) {
          const b = rawBackend[i] || 0;
          const f = rawFrontend[i] || 0;
          const infr = rawInfra[i] || 0;
          const total = b + f + infr;

          if (total > 0) {
            validMonths.push({
              label: rawLabels[i],
              backend: b,
              frontend: f,
              infra: infr,
            });
          }
        }

        // データがある月の中から,最新の3ヶ月分を取得
        const displayedData = validMonths.slice(-3);

        // 各データ配列の再構築
        const filteredLabels = displayedData.map((d) => d.label);
        const backendData = displayedData.map((d) => d.backend);
        const frontendData = displayedData.map((d) => d.frontend);
        const infraData = displayedData.map((d) => d.infra);

        // ラベルの名称変換
        const finalLabels = filteredLabels.map((label, index) => {
          const distance = filteredLabels.length - 1 - index;

          if (distance === 0) return "今月";
          if (distance === 1) return "先月";
          if (distance === 2) return "先々月";

          return label;
        });

        // Y軸の最大値計算
        let maxTotal = 0;
        for (let i = 0; i < backendData.length; i++) {
          const sum = backendData[i] + frontendData[i] + infraData[i];
          if (sum > maxTotal) maxTotal = sum;
        }
        const step = 10;
        const yMax =
          maxTotal > 0 ? Math.ceil((maxTotal + 1) / step) * step : 50;

        const config = {
          type: "bar",
          data: {
            labels: finalLabels,
            datasets: [
              {
                label: "バックエンド",
                data: backendData,
                backgroundColor: "#F3B5C2",
                borderColor: "#F4B7C4",
                barPercentage: 0.8,
                categoryPercentage: 0.9,
              },
              {
                label: "フロントエンド",
                data: frontendData,
                backgroundColor: "#F7D1AA",
                borderColor: "#F1AB6B",
                borderWidth: 1,
                barPercentage: 0.8,
                categoryPercentage: 0.9,
              },
              {
                label: "インフラ",
                data: infraData,
                backgroundColor: "#FAE6B5",
                borderColor: "#F6CE72",
                borderWidth: 1,
                barPercentage: 0.8,
                categoryPercentage: 0.9,
              },
            ],
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: "Chart.js Bar Chart",
                font: {
                  size: 16,
                  weight: "bold",
                },
                color: "#666",
              },
              label: {
                font: {
                  size: 14,
                  weight: "regular",
                  color: "#000",
                },
              },
            },
            scales: {
              x: {
                grid: {
                  display: true,
                  drawBorder: true,
                  borderColor: "#ccc",
                },
              },
              y: {
                beginAtZero: true,
                min: 0,
                max: yMax,
                ticks: {
                  stepSize: step,
                  precision: 0,
                },
              },
            },
          },
        };

        // 描画実行
        try {
          const ctx = canvas.getContext("2d");
          const chartStatus = Chart.getChart(canvas);
          if (chartStatus !== undefined) {
            chartStatus.destroy();
          }
          new Chart(ctx, config);
        } catch (e) {
          console.error("Failed to render chart:", e);
        }
      };

      // 起動タイミングの制御
      if (document.readyState === "complete") {
        initLearningChart();
      } else {
        window.addEventListener("load", initLearningChart);
      }
    })();
    /*]]>*/
  </script>
</html>
